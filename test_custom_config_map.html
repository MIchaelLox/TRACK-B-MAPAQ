
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive MAPAQ - Risques Sanitaires</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .map-controls { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 300px; }
        .restaurant-popup { min-width: 250px; font-size: 14px; }
        .popup-content p { margin: 5px 0; }
        .popup-actions { margin-top: 10px; text-align: center; }
        .popup-actions button { margin: 2px; }
        .legend { position: absolute; bottom: 20px; left: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
        .stats-panel { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 200px; }
        @media (max-width: 768px) { .map-controls, .stats-panel { position: relative; width: 100%; margin: 10px 0; } #map { height: 70vh; } }
    </style>
</head>
<body>
    <!-- Panneau de statistiques -->
    <div class="stats-panel">
        <h5><i class="fas fa-chart-bar"></i> Statistiques</h5>
        <div id="stats-content">
            <p><strong>Total restaurants:</strong> <span id="total-count">0</span></p>
            <p><strong>Risque critique:</strong> <span id="critical-count">0</span></p>
            <p><strong>Risque élevé:</strong> <span id="high-count">0</span></p>
            <p><strong>Risque modéré:</strong> <span id="medium-count">0</span></p>
            <p><strong>Risque faible:</strong> <span id="low-count">0</span></p>
        </div>
    </div>
    
    <!-- Contrôles de la carte -->
    <div class="map-controls">
        <h5><i class="fas fa-sliders-h"></i> Contrôles</h5>
        <div class="mb-3">
            <label class="form-label">Affichage:</label>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="show-markers" checked>
                <label class="form-check-label" for="show-markers">Marqueurs</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="show-clusters" checked>
                <label class="form-check-label" for="show-clusters">Clusters</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="show-heatmap">
                <label class="form-check-label" for="show-heatmap">Heatmap</label>
            </div>
        </div>
        <div class="mb-3">
            <label for="risk-filter" class="form-label">Filtrer par risque:</label>
            <select class="form-select" id="risk-filter">
                <option value="all">Tous les niveaux</option>
                <option value="Critique">Critique uniquement</option>
                <option value="Élevé">Élevé uniquement</option>
                <option value="Modéré">Modéré uniquement</option>
                <option value="Faible">Faible uniquement</option>
            </select>
        </div>
        <button class="btn btn-primary btn-sm" onclick="resetMap()">
            <i class="fas fa-home"></i> Réinitialiser
        </button>
    </div>
    
    <!-- Carte principale -->
    <div id="map"></div>
    
    <!-- Légende -->
    <div class="legend">
        <h6><i class="fas fa-info-circle"></i> Niveaux de risque</h6>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #dc3545;"></div>
            <span>Critique (≥ 0.8)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #fd7e14;"></div>
            <span>Élevé (0.6 - 0.8)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffc107;"></div>
            <span>Modéré (0.3 - 0.6)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #28a745;"></div>
            <span>Faible (< 0.3)</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Données des restaurants
        const markersData = [
  {
    "id": "demo_1",
    "lat": 45.5088,
    "lng": -73.5878,
    "nom": "Restaurant Chez Mario",
    "adresse": "123 Rue Saint-Denis, Montréal",
    "theme": "Italien",
    "score_risque": 0.25,
    "categorie_risque": "Faible",
    "probabilite_infraction": 0.15,
    "color": "#28a745",
    "icon": "check-circle",
    "popup_html": "<div class=\"restaurant-popup\">\n            <h3 style=\"color: #28a745; margin: 0 0 10px 0;\">\n                <i class=\"fas fa-check-circle\"></i>\n                Restaurant Chez Mario\n            </h3>\n            <div class=\"popup-content\">\n                <p><strong>Adresse:</strong> 123 Rue Saint-Denis, Montréal</p>\n                <p><strong>Thème:</strong> Italien</p>\n                <p><strong>Catégorie de risque:</strong> \n                   <span style=\"color: #28a745; font-weight: bold;\">\n                       Faible\n                   </span>\n                </p>\n                <p><strong>Score de risque:</strong> 0.25/1.00</p>\n                <p><strong>Probabilité d'infraction:</strong> 15.0%</p>\n                <p><strong>Dernière inspection:</strong> 2024-12-15</p>\n                <p><strong>Nombre d'infractions:</strong> 0</p>\n            </div>\n            <div class=\"popup-actions\">\n                <button onclick=\"showRestaurantDetails('demo_1')\" \n                        class=\"btn btn-info btn-sm\">\n                    Détails complets\n                </button>\n                <button onclick=\"scheduleInspection('demo_1')\" \n                        class=\"btn btn-warning btn-sm\">\n                    Programmer inspection\n                </button>\n            </div>\n        </div>"
  },
  {
    "id": "demo_2",
    "lat": 45.5017,
    "lng": -73.5673,
    "nom": "Sushi Express",
    "adresse": "456 Boulevard Saint-Laurent, Montréal",
    "theme": "Asiatique",
    "score_risque": 0.65,
    "categorie_risque": "Modéré",
    "probabilite_infraction": 0.45,
    "color": "#ffc107",
    "icon": "exclamation-triangle",
    "popup_html": "<div class=\"restaurant-popup\">\n            <h3 style=\"color: #ffc107; margin: 0 0 10px 0;\">\n                <i class=\"fas fa-exclamation-triangle\"></i>\n                Sushi Express\n            </h3>\n            <div class=\"popup-content\">\n                <p><strong>Adresse:</strong> 456 Boulevard Saint-Laurent, Montréal</p>\n                <p><strong>Thème:</strong> Asiatique</p>\n                <p><strong>Catégorie de risque:</strong> \n                   <span style=\"color: #ffc107; font-weight: bold;\">\n                       Modéré\n                   </span>\n                </p>\n                <p><strong>Score de risque:</strong> 0.65/1.00</p>\n                <p><strong>Probabilité d'infraction:</strong> 45.0%</p>\n                <p><strong>Dernière inspection:</strong> 2024-11-20</p>\n                <p><strong>Nombre d'infractions:</strong> 2</p>\n            </div>\n            <div class=\"popup-actions\">\n                <button onclick=\"showRestaurantDetails('demo_2')\" \n                        class=\"btn btn-info btn-sm\">\n                    Détails complets\n                </button>\n                <button onclick=\"scheduleInspection('demo_2')\" \n                        class=\"btn btn-warning btn-sm\">\n                    Programmer inspection\n                </button>\n            </div>\n        </div>"
  },
  {
    "id": "demo_3",
    "lat": 45.4995,
    "lng": -73.5848,
    "nom": "BBQ Palace",
    "adresse": "789 Rue Sainte-Catherine, Montréal",
    "theme": "Américain",
    "score_risque": 0.85,
    "categorie_risque": "Élevé",
    "probabilite_infraction": 0.75,
    "color": "#fd7e14",
    "icon": "exclamation-circle",
    "popup_html": "<div class=\"restaurant-popup\">\n            <h3 style=\"color: #fd7e14; margin: 0 0 10px 0;\">\n                <i class=\"fas fa-exclamation-circle\"></i>\n                BBQ Palace\n            </h3>\n            <div class=\"popup-content\">\n                <p><strong>Adresse:</strong> 789 Rue Sainte-Catherine, Montréal</p>\n                <p><strong>Thème:</strong> Américain</p>\n                <p><strong>Catégorie de risque:</strong> \n                   <span style=\"color: #fd7e14; font-weight: bold;\">\n                       Élevé\n                   </span>\n                </p>\n                <p><strong>Score de risque:</strong> 0.85/1.00</p>\n                <p><strong>Probabilité d'infraction:</strong> 75.0%</p>\n                <p><strong>Dernière inspection:</strong> 2024-10-10</p>\n                <p><strong>Nombre d'infractions:</strong> 5</p>\n            </div>\n            <div class=\"popup-actions\">\n                <button onclick=\"showRestaurantDetails('demo_3')\" \n                        class=\"btn btn-info btn-sm\">\n                    Détails complets\n                </button>\n                <button onclick=\"scheduleInspection('demo_3')\" \n                        class=\"btn btn-warning btn-sm\">\n                    Programmer inspection\n                </button>\n            </div>\n        </div>"
  },
  {
    "id": "demo_4",
    "lat": 45.515,
    "lng": -73.555,
    "nom": "Fast Burger",
    "adresse": "321 Avenue du Parc, Montréal",
    "theme": "Fast Food",
    "score_risque": 0.95,
    "categorie_risque": "Critique",
    "probabilite_infraction": 0.9,
    "color": "#dc3545",
    "icon": "times-circle",
    "popup_html": "<div class=\"restaurant-popup\">\n            <h3 style=\"color: #dc3545; margin: 0 0 10px 0;\">\n                <i class=\"fas fa-times-circle\"></i>\n                Fast Burger\n            </h3>\n            <div class=\"popup-content\">\n                <p><strong>Adresse:</strong> 321 Avenue du Parc, Montréal</p>\n                <p><strong>Thème:</strong> Fast Food</p>\n                <p><strong>Catégorie de risque:</strong> \n                   <span style=\"color: #dc3545; font-weight: bold;\">\n                       Critique\n                   </span>\n                </p>\n                <p><strong>Score de risque:</strong> 0.95/1.00</p>\n                <p><strong>Probabilité d'infraction:</strong> 90.0%</p>\n                <p><strong>Dernière inspection:</strong> 2024-09-05</p>\n                <p><strong>Nombre d'infractions:</strong> 8</p>\n            </div>\n            <div class=\"popup-actions\">\n                <button onclick=\"showRestaurantDetails('demo_4')\" \n                        class=\"btn btn-info btn-sm\">\n                    Détails complets\n                </button>\n                <button onclick=\"scheduleInspection('demo_4')\" \n                        class=\"btn btn-warning btn-sm\">\n                    Programmer inspection\n                </button>\n            </div>\n        </div>"
  }
];
        const clustersData = {
  "Faible": {
    "count": 1,
    "color": "#28a745",
    "restaurants": [
      {
        "id": "demo_1",
        "lat": 45.5088,
        "lng": -73.5878,
        "nom": "Restaurant Chez Mario",
        "score_risque": 0.25
      }
    ]
  },
  "Modéré": {
    "count": 1,
    "color": "#ffc107",
    "restaurants": [
      {
        "id": "demo_2",
        "lat": 45.5017,
        "lng": -73.5673,
        "nom": "Sushi Express",
        "score_risque": 0.65
      }
    ]
  },
  "Élevé": {
    "count": 1,
    "color": "#fd7e14",
    "restaurants": [
      {
        "id": "demo_3",
        "lat": 45.4995,
        "lng": -73.5848,
        "nom": "BBQ Palace",
        "score_risque": 0.85
      }
    ]
  },
  "Critique": {
    "count": 1,
    "color": "#dc3545",
    "restaurants": [
      {
        "id": "demo_4",
        "lat": 45.515,
        "lng": -73.555,
        "nom": "Fast Burger",
        "score_risque": 0.95
      }
    ]
  }
};
        const heatmapData = [
  [
    45.5088,
    -73.5878,
    0.25
  ],
  [
    45.5017,
    -73.5673,
    0.65
  ],
  [
    45.4995,
    -73.5848,
    0.85
  ],
  [
    45.515,
    -73.555,
    0.95
  ]
];
        
        // Configuration de la carte
        const mapConfig = {
            center: [45.52, -73.58],
            zoom: 12,
            minZoom: 8,
            maxZoom: 18
        };
        
        // Initialisation de la carte
        const map = L.map('map').setView(mapConfig.center, mapConfig.zoom);
        
        // Couche de tuiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors | MAPAQ Track-B',
            minZoom: mapConfig.minZoom,
            maxZoom: mapConfig.maxZoom
        }).addTo(map);
        
        // Groupes de couches
        const markersGroup = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 50
        });
        const heatmapGroup = L.layerGroup();
        
        // Variables globales
        let allMarkers = [];
        let currentFilter = 'all';
        
        // Initialisation
        initializeMap();
        updateStatistics();
        
        function initializeMap() {
            // Création des marqueurs
            markersData.forEach(restaurant => {
                const marker = createRestaurantMarker(restaurant);
                allMarkers.push({marker: marker, data: restaurant});
                markersGroup.addLayer(marker);
            });
            
            // Ajout des groupes à la carte
            map.addLayer(markersGroup);
            
            // Création de la heatmap
            if (heatmapData.length > 0) {
                const heatLayer = L.heatLayer(heatmapData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    gradient: {
                        0.0: '#28a745',
                        0.3: '#ffc107', 
                        0.6: '#fd7e14',
                        0.8: '#dc3545'
                    }
                });
                heatmapGroup.addLayer(heatLayer);
            }
        }
        
        function createRestaurantMarker(restaurant) {
            // Icône personnalisée basée sur le risque
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${restaurant.color};
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 12px;
                ">
                    <i class="fas fa-${restaurant.icon}"></i>
                </div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
            
            const marker = L.marker([restaurant.lat, restaurant.lng], {icon: icon});
            marker.bindPopup(restaurant.popup_html, {
                maxWidth: 350,
                className: 'custom-popup'
            });
            
            return marker;
        }
        
        function updateStatistics() {
            const stats = {
                total: markersData.length,
                critical: markersData.filter(r => r.categorie_risque === 'Critique').length,
                high: markersData.filter(r => r.categorie_risque === 'Élevé').length,
                medium: markersData.filter(r => r.categorie_risque === 'Modéré').length,
                low: markersData.filter(r => r.categorie_risque === 'Faible').length
            };
            
            document.getElementById('total-count').textContent = stats.total;
            document.getElementById('critical-count').textContent = stats.critical;
            document.getElementById('high-count').textContent = stats.high;
            document.getElementById('medium-count').textContent = stats.medium;
            document.getElementById('low-count').textContent = stats.low;
        }
        
        // Gestionnaires d'événements
        document.getElementById('show-markers').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(markersGroup);
            } else {
                map.removeLayer(markersGroup);
            }
        });
        
        document.getElementById('show-clusters').addEventListener('change', function(e) {
            // Toggle clustering
            if (e.target.checked) {
                markersGroup.options.disableClusteringAtZoom = null;
            } else {
                markersGroup.options.disableClusteringAtZoom = 1;
            }
            markersGroup.refreshClusters();
        });
        
        document.getElementById('show-heatmap').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(heatmapGroup);
            } else {
                map.removeLayer(heatmapGroup);
            }
        });
        
        document.getElementById('risk-filter').addEventListener('change', function(e) {
            currentFilter = e.target.value;
            filterMarkers();
        });
        
        function filterMarkers() {
            markersGroup.clearLayers();
            
            const filteredMarkers = allMarkers.filter(item => {
                if (currentFilter === 'all') return true;
                return item.data.categorie_risque === currentFilter;
            });
            
            filteredMarkers.forEach(item => {
                markersGroup.addLayer(item.marker);
            });
        }
        
        function resetMap() {
            map.setView(mapConfig.center, mapConfig.zoom);
            document.getElementById('risk-filter').value = 'all';
            currentFilter = 'all';
            filterMarkers();
        }
        
        // Fonctions pour les popups
        function showRestaurantDetails(restaurantId) {
            const restaurant = markersData.find(r => r.id === restaurantId);
            if (restaurant) {
                alert(`Détails complets pour: ${restaurant.nom}\n\nCette fonctionnalité sera intégrée au dashboard principal.`);
            }
        }
        
        function scheduleInspection(restaurantId) {
            const restaurant = markersData.find(r => r.id === restaurantId);
            if (restaurant) {
                alert(`Programmer une inspection pour: ${restaurant.nom}\n\nCette fonctionnalité sera intégrée au système de gestion.`);
            }
        }
    </script>
</body>
</html>
        