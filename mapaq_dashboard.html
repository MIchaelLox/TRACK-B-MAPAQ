<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MAPAQ Interactif - Syst√®me Pr√©dictif de Risques</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2C3E50;
            --danger-color: #E74C3C;
            --warning-color: #F39C12;
            --success-color: #27AE60;
            --info-color: #3498DB;
            --bg-light: #ECF0F1;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495E 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .stat-card {
            border: none;
            border-radius: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
            background: white;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .stat-icon { font-size: 3rem; opacity: 0.8; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin: 10px 0; }
        .trend-up { color: var(--danger-color); }
        .trend-down { color: var(--success-color); }
        .trend-neutral { color: var(--info-color); }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .table thead {
            background: var(--primary-color);
            color: white;
        }
        
        .table thead th {
            cursor: pointer;
            user-select: none;
        }
        
        .badge-critique { background-color: var(--danger-color); color: white; padding: 8px 15px; border-radius: 20px; }
        .badge-eleve { background-color: var(--warning-color); color: white; padding: 8px 15px; border-radius: 20px; }
        .badge-moyen { background-color: var(--info-color); color: white; padding: 8px 15px; border-radius: 20px; }
        .badge-faible { background-color: var(--success-color); color: white; padding: 8px 15px; border-radius: 20px; }
        
        .btn-view-details {
            background: var(--info-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container { position: relative; height: 300px; padding: 20px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> Dashboard MAPAQ Interactif</h1>
                    <p>Syst√®me Pr√©dictif de Risques Sanitaires - Surveillance en Temps R√©el</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
                
        <!-- Statistiques principales -->
        <div class="row" id="statsContainer">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="card-body text-center">
                        <div class="stat-icon">üè™</div>
                        <div class="stat-label">Total Restaurants</div>
                        <div class="stat-value" id="totalRestaurants">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="card-body text-center">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Score Moyen</div>
                        <div class="stat-value" id="scoreMoyen">-</div>
                        <small class="trend-down" id="scoreTrend"></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="card-body text-center">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-label">Risque √âlev√©</div>
                        <div class="stat-value" id="risqueEleve">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="card-body text-center">
                        <div class="stat-icon">üö®</div>
                        <div class="stat-label">Critique</div>
                        <div class="stat-value" id="critique">-</div>
                        <small class="trend-neutral">Inspection urgente</small>
                    </div>
                </div>
            </div>
        </div>
        
                
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        
        <div id="risk_distribution_chart" class="chart-container">
            <canvas id="risk_distribution_chart_canvas"></canvas>
            <script>
                // Configuration du graphique pie
                const ctx_risk_distribution_chart = document.getElementById('risk_distribution_chart_canvas').getContext('2d');
                const chart_risk_distribution_chart = new Chart(ctx_risk_distribution_chart, {
                    type: 'pie',
                    data: {"labels": ["Critique", "\u00c9lev\u00e9", "Moyen", "Faible"], "datasets": [{"data": [3, 5, 12, 5], "backgroundColor": ["#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4"]}]},
                    options: {"responsive": true, "plugins": {"title": {"display": true, "text": "Distribution des Cat\u00e9gories de Risque"}}}
                });
            </script>
        </div>
        
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        
        <div id="trends_chart" class="chart-container">
            <canvas id="trends_chart_canvas"></canvas>
            <script>
                // Configuration du graphique line
                const ctx_trends_chart = document.getElementById('trends_chart_canvas').getContext('2d');
                const chart_trends_chart = new Chart(ctx_trends_chart, {
                    type: 'line',
                    data: {"labels": ["Jan", "F\u00e9v", "Mar", "Avr", "Mai", "Jun"], "datasets": [{"label": "Score Moyen", "data": [58, 62, 55, 60, 58, 63], "borderColor": "#FF6B6B", "tension": 0.1}]},
                    options: {"responsive": true, "plugins": {"title": {"display": true, "text": "\u00c9volution des Scores de Risque"}}, "scales": {"y": {"beginAtZero": true, "max": 100}}}
                });
            </script>
        </div>
        
                    </div>
                </div>
            </div>
        </div>
        
                
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Liste des Restaurants</h5>
                        <button class="btn btn-primary btn-sm float-end" onclick="refreshTable()">
                            üîÑ Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        
        <div id="restaurants_table" class="table-responsive interactive-table">
            
            <div class="table-search mb-3">
                <input type="text" class="form-control" placeholder="Rechercher..." 
                       onkeyup="filterTable('restaurants_table_table', this.value)">
            </div>
            
            <table id="restaurants_table_table" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr><th data-sortable="true">Restaurant</th><th data-sortable="true">Zone</th><th data-sortable="true">Score</th><th data-sortable="true">Cat√©gorie</th><th data-sortable="true">Derni√®re Inspection</th></tr>
                </thead>
                <tbody>
                    <tr><td>Restaurant Test</td><td></td><td>65.2</td><td>eleve</td><td></td></tr>
                </tbody>
            </table>
        </div>
        
                    </div>
                </div>
            </div>
        </div>
        
            </div>
            
            <!-- Bootstrap JS -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            
            <script>
                // Configuration API
                const API_BASE_URL = 'http://127.0.0.1:5000/api/v1';
                
                // Variables globales
                let allRestaurants = [];
                let distributionChart = null;
                let trendsChart = null;
                
                // Initialisation au chargement
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('üöÄ Initialisation du dashboard...');
                    initDashboard();
                    
                    // Auto-refresh toutes les 30 secondes
                    setInterval(refreshAllData, 30000);
                });
                
                // Initialisation du dashboard
                async function initDashboard() {
                    try {
                        await loadDashboardData();
                        await loadRestaurants();
                        await loadCharts();
                        console.log('‚úÖ Dashboard initialis√© avec succ√®s');
                    } catch (error) {
                        console.error('‚ùå Erreur initialisation:', error);
                    }
                }
                
                // Chargement des statistiques du dashboard
                async function loadDashboardData() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/dashboard`);
                        const data = await response.json();
                        
                        document.getElementById('totalRestaurants').textContent = data.stats.total_restaurants;
                        document.getElementById('scoreMoyen').textContent = data.stats.score_moyen + '/100';
                        document.getElementById('risqueEleve').textContent = data.stats.risque_eleve;
                        document.getElementById('critique').textContent = data.stats.critique;
                        
                        const trend = data.stats.trend;
                        const trendElement = document.getElementById('scoreTrend');
                        if (trend > 0) {
                            trendElement.className = 'trend-up';
                            trendElement.textContent = `‚Üó +${trend.toFixed(1)} points`;
                        } else if (trend < 0) {
                            trendElement.className = 'trend-down';
                            trendElement.textContent = `‚Üò ${trend.toFixed(1)} points`;
                        } else {
                            trendElement.className = 'trend-neutral';
                            trendElement.textContent = '‚Üí Stable';
                        }
                    } catch (error) {
                        console.error('Erreur chargement dashboard:', error);
                    }
                }
                
                // Chargement des restaurants
                async function loadRestaurants() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/restaurants`);
                        const data = await response.json();
                        
                        allRestaurants = data.restaurants;
                        displayRestaurants(allRestaurants);
                    } catch (error) {
                        console.error('Erreur chargement restaurants:', error);
                    }
                }
                
                // Affichage des restaurants dans le tableau
                function displayRestaurants(restaurants) {
                    const tbody = document.querySelector('#restaurants_table_table tbody');
                    
                    if (restaurants.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucun restaurant trouv√©</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = restaurants.map(resto => `
                        <tr>
                            <td><strong>${resto.nom}</strong><br><small class="text-muted">${resto.theme || 'N/A'}</small></td>
                            <td>${resto.zone || 'N/A'}</td>
                            <td><strong style="color: ${getScoreColor(resto.score_risque)}">${resto.score_risque}/100</strong></td>
                            <td><span class="badge-${resto.categorie_risque}">${getCategorieLabel(resto.categorie_risque)}</span></td>
                            <td>${formatDate(resto.derniere_inspection)}</td>
                            <td><button class="btn btn-view-details btn-sm" onclick="alert('D√©tails: ${resto.nom}')"><i class="fas fa-eye"></i></button></td>
                        </tr>
                    `).join('');
                }
                
                // Chargement des graphiques
                async function loadCharts() {
                    await loadDistributionChart();
                    await loadTrendsChart();
                }
                
                // Graphique de distribution
                async function loadDistributionChart() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/charts/distribution`);
                        const data = await response.json();
                        
                        const ctx = document.getElementById('risk_distribution_chart_canvas').getContext('2d');
                        
                        if (distributionChart) {
                            distributionChart.destroy();
                        }
                        
                        distributionChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    data: data.data,
                                    backgroundColor: data.backgroundColor,
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom' },
                                    title: { display: true, text: 'Distribution des Cat√©gories de Risque' }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Erreur chargement graphique distribution:', error);
                    }
                }
                
                // Graphique de tendances
                async function loadTrendsChart() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/charts/trends?period=month`);
                        const data = await response.json();
                        
                        const ctx = document.getElementById('trends_chart_canvas').getContext('2d');
                        
                        if (trendsChart) {
                            trendsChart.destroy();
                        }
                        
                        trendsChart = new Chart(ctx, {
                            type: 'line',
                            data: data,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom' },
                                    title: { display: true, text: '√âvolution des Scores de Risque' }
                                },
                                scales: {
                                    y: { beginAtZero: true, max: 100 }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Erreur chargement graphique tendances:', error);
                    }
                }
                
                // Actualisation compl√®te
                async function refreshAllData() {
                    console.log('üîÑ Actualisation des donn√©es...');
                    await loadDashboardData();
                    await loadRestaurants();
                    await loadCharts();
                    console.log('‚úÖ Donn√©es actualis√©es');
                }
                
                // Fonctions utilitaires
                function getScoreColor(score) {
                    if (score >= 80) return '#E74C3C';
                    if (score >= 60) return '#F39C12';
                    if (score >= 40) return '#3498DB';
                    return '#27AE60';
                }
                
                function getCategorieLabel(categorie) {
                    const labels = {
                        'critique': 'Critique',
                        'eleve': '√âlev√©',
                        'moyen': 'Moyen',
                        'faible': 'Faible'
                    };
                    return labels[categorie] || categorie;
                }
                
                function formatDate(dateStr) {
                    if (!dateStr) return 'N/A';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('fr-CA');
                }
                
                function filterTable(tableId, searchValue) {
                    const filtered = allRestaurants.filter(r => {
                        const searchable = `${r.nom} ${r.zone} ${r.theme} ${r.adresse}`.toLowerCase();
                        return searchable.includes(searchValue.toLowerCase());
                    });
                    displayRestaurants(filtered);
                }
                
                function refreshTable() {
                    loadRestaurants();
                }
            </script>
        </body>
        </html>